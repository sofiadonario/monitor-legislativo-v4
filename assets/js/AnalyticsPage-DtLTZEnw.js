import{j as e,L as s}from"./index-DQmXZ-MY.js";import{r as n}from"./leaflet-vendor-CuwtxqHJ.js";import"./react-vendor-DFJYf2oa.js";var t={},a=Object.defineProperty,i=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,o=(e,s,n)=>s in e?a(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n,c=(e,s)=>{for(var n in s||(s={}))r.call(s,n)&&o(e,n,s[n]);if(i)for(var n of i(s))l.call(s,n)&&o(e,n,s[n]);return e};const u={baseUrl:t.REACT_APP_RSHINY_URL||"http://localhost:3838",allowedOrigins:["http://localhost:3838","https://*.shinyapps.io","https://sofiadonario.github.io","https://sofiadonario.github.io/monitor-legislativo-v4"],sandbox:"allow-same-origin allow-scripts allow-forms allow-popups",sessionTimeout:45e3,retryAttempts:5,retryDelay:3e3,heartbeatInterval:3e4,pollingInterval:15e3,maxQueueSize:30,loadTimeout:2e4},d=c(c({},{baseUrl:t.REACT_APP_RSHINY_URL||"http://localhost:3838",apiEndpoint:"/api/sync",healthEndpoint:"/health",allowedOrigins:["http://localhost:3838","https://shinyapps.io",t.REACT_APP_RSHINY_URL||""].filter(Boolean),sandbox:"allow-same-origin allow-scripts allow-forms allow-popups allow-pointer-lock",allowFullscreen:!0,sessionTimeout:3e4,retryAttempts:3,retryDelay:5e3,heartbeatInterval:3e4,syncFiltersDelay:1e3,syncDocumentsDelay:2e3,maxQueueSize:50,enableWebSocket:!1,enablePolling:!0,pollingInterval:1e4,loadTimeout:15e3}),u),h=e=>{if("object"!=typeof e||null===e)return{};const s=c({},e);return delete s.__proto__,delete s.constructor,Object.keys(s).forEach(e=>{"object"==typeof s[e]&&null!==s[e]&&(s[e]=h(s[e]))}),s};var m=({url:t,title:a="R Shiny Analytics",height:i="600px",width:r="100%",onLoad:l,onError:o,className:c=""})=>{const[u,h]=n.useState(!0),[m,y]=n.useState(!1),[p,g]=n.useState(""),f=n.useRef(null);n.useEffect(()=>{const e=f.current;if(!e)return;const s=()=>{h(!1),y(!1),null==l||l()},n=()=>{h(!1),y(!0);const e="Failed to load R Shiny application";g(e),null==o||o(e)};e.addEventListener("load",s),e.addEventListener("error",n);const t=setTimeout(()=>{if(u){h(!1),y(!0);const e="R Shiny application load timeout";g(e),null==o||o(e)}},d.loadTimeout);return()=>{e.removeEventListener("load",s),e.removeEventListener("error",n),clearTimeout(t)}},[t,u,l,o]);const S=()=>{if(h(!0),y(!1),g(""),f.current){const e=new URL(t);e.searchParams.set("_t",Date.now().toString()),f.current.src=e.toString()}},b={sandbox:d.sandbox,allowFullScreen:d.allowFullscreen,referrerPolicy:"strict-origin-when-cross-origin",loading:"lazy"};return m?e.jsx("div",{className:`r-shiny-embed-error ${c}`,children:e.jsxs("div",{className:"error-content",children:[e.jsx("div",{className:"error-icon",children:"⚠️"}),e.jsx("h3",{children:"R Shiny Application Unavailable"}),e.jsx("p",{children:p}),e.jsxs("div",{className:"error-details",children:[e.jsx("p",{children:"The R Shiny analytics application could not be loaded. This may be due to:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"The R Shiny server is temporarily unavailable"}),e.jsx("li",{children:"Network connectivity issues"}),e.jsx("li",{children:"Application deployment problems"})]})]}),e.jsxs("div",{className:"error-actions",children:[e.jsx("button",{onClick:S,className:"retry-btn",children:"🔄 Try Again"}),e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"external-link-btn",children:"🔗 Open in New Tab"})]})]})}):e.jsxs("div",{className:`r-shiny-embed ${c}`,children:[u&&e.jsxs("div",{className:"r-shiny-loading",children:[e.jsx(s,{message:"Loading R Shiny Analytics..."}),e.jsxs("p",{className:"loading-details",children:["Connecting to R Shiny application at ",new URL(t).hostname]})]}),e.jsx("iframe",{ref:f,src:t,title:a,width:r,height:i,frameBorder:"0",sandbox:b.sandbox,allowFullScreen:b.allowFullScreen,referrerPolicy:b.referrerPolicy,loading:b.loading,className:"r-shiny-iframe "+(u?"loading":"loaded"),style:{display:u?"none":"block"}}),!u&&!m&&e.jsxs("div",{className:"r-shiny-controls",children:[e.jsx("button",{onClick:S,className:"refresh-btn",title:"Refresh R Shiny application",children:"🔄"}),e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"external-btn",title:"Open in new tab",children:"🔗"})]})]})},y=Object.defineProperty,p=(e,s,n)=>((e,s,n)=>s in e?y(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n)(e,"symbol"!=typeof s?s+"":s,n),g=(e,s,n)=>new Promise((t,a)=>{var i=e=>{try{l(n.next(e))}catch(s){a(s)}},r=e=>{try{l(n.throw(e))}catch(s){a(s)}},l=e=>e.done?t(e.value):Promise.resolve(e.value).then(i,r);l((n=n.apply(e,s)).next())});const f=new class{constructor(){p(this,"sessionId"),p(this,"eventTarget"),p(this,"syncQueue",[]),p(this,"isOnline",!0),p(this,"retryTimeout",null),this.sessionId=this.generateSessionId(),this.eventTarget=new EventTarget,this.initializeConnectionMonitoring()}generateSessionId(){return`react_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}initializeConnectionMonitoring(){setInterval(()=>{this.checkRShinyHealth()},12e4),setTimeout(()=>{this.checkRShinyHealth()},5e3)}checkRShinyHealth(){return g(this,null,function*(){try{const e=(yield fetch(`${d.baseUrl}${d.healthEndpoint}`,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok;return this.isOnline!==e&&(this.isOnline=e,this.eventTarget.dispatchEvent(new CustomEvent("connectionchange",{detail:{isOnline:this.isOnline}}))),e}catch(e){return console.warn("R Shiny health check failed:",e),this.isOnline&&(this.isOnline=!1,this.eventTarget.dispatchEvent(new CustomEvent("connectionchange",{detail:{isOnline:!1,error:e}}))),!1}})}syncFilters(e){return g(this,null,function*(){const s={timestamp:Date.now(),type:"filters",data:h({searchTerm:e.searchTerm,documentTypes:e.documentTypes,states:e.states,municipalities:e.municipalities,dateRange:{from:e.dateFrom,to:e.dateTo},keywords:e.keywords}),sessionId:this.sessionId};return this.sendDataPacket(s)})}syncDocuments(e){return g(this,null,function*(){const s=e.map(e=>({id:e.id,title:e.title,type:e.type,number:e.number,date:e.date,state:e.state,municipality:e.municipality,author:e.author,summary:e.summary,url:e.url,source:e.source,chamber:e.chamber})),n={timestamp:Date.now(),type:"documents",data:h({documents:s,count:s.length,lastUpdated:(new Date).toISOString()}),sessionId:this.sessionId};return this.sendDataPacket(n)})}syncSelection(e,s){return g(this,null,function*(){const n={timestamp:Date.now(),type:"selection",data:h({selectedState:e,selectedMunicipality:s,selectionTimestamp:Date.now()}),sessionId:this.sessionId};return this.sendDataPacket(n)})}sendCommand(e){return g(this,arguments,function*(e,s={}){const n={timestamp:Date.now(),type:"command",data:h({command:e,parameters:h(s),responseRequired:!0}),sessionId:this.sessionId};try{return yield this.sendDataPacketWithResponse(n)}catch(t){throw console.error("Error sending command to R Shiny:",t),t}})}getSessionData(){return g(this,null,function*(){try{const e=yield fetch(`${d.baseUrl}${d.apiEndpoint}/session/${this.sessionId}`,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(d.loadTimeout)});if(!e.ok)throw new Error(`Failed to get session data: ${e.status}`);return yield e.json()}catch(e){throw console.error("Error getting session data from R Shiny:",e),e}})}sendDataPacket(e){return g(this,null,function*(){if(!this.isOnline)return console.warn("R Shiny is offline, queueing data packet"),this.syncQueue.push(e),!1;try{if("undefined"!=typeof window&&(s=window.location.origin,!d.allowedOrigins.some(e=>{if(e===s)return!0;if(e.startsWith("*.")){const n=e.slice(2);return s.endsWith(`.${n}`)||s===n}return!1})))throw new Error("Origin not allowed for R Shiny communication");const n=yield fetch(`${d.baseUrl}${d.apiEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(d.loadTimeout)});if(!n.ok)throw new Error(`Sync failed: ${n.status} ${n.statusText}`);return console.log(`Successfully synced ${e.type} data to R Shiny`),!0}catch(n){return console.error("Error syncing data to R Shiny:",n),this.syncQueue.push(e),this.scheduleRetry(),!1}var s})}sendDataPacketWithResponse(e){return g(this,null,function*(){const s=yield fetch(`${d.baseUrl}${d.apiEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(d.loadTimeout)});if(!s.ok)throw new Error(`Command failed: ${s.status} ${s.statusText}`);return yield s.json()})}scheduleRetry(){this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=setTimeout(()=>{this.processSyncQueue()},5e3)}processSyncQueue(){return g(this,null,function*(){if(0===this.syncQueue.length||!this.isOnline)return;console.log(`Processing ${this.syncQueue.length} queued sync packets`);const e=[...this.syncQueue];this.syncQueue=[];for(const s of e)if(!(yield this.sendDataPacket(s)))break})}onConnectionChange(e){const s=s=>{const n=s;e(n.detail.isOnline,n.detail.error)};return this.eventTarget.addEventListener("connectionchange",s),()=>{this.eventTarget.removeEventListener("connectionchange",s)}}isConnected(){return this.isOnline}getQueueSize(){return this.syncQueue.length}clearQueue(){this.syncQueue=[]}getRShinyUrl(){return d.baseUrl}getSessionId(){return this.sessionId}dispose(){this.retryTimeout&&clearTimeout(this.retryTimeout),this.clearQueue()}};var S=Object.defineProperty,b=Object.defineProperties,j=Object.getOwnPropertyDescriptors,v=Object.getOwnPropertySymbols,x=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,N=(e,s,n)=>s in e?S(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n,T=(e,s)=>{for(var n in s||(s={}))x.call(s,n)&&N(e,n,s[n]);if(v)for(var n of v(s))w.call(s,n)&&N(e,n,s[n]);return e},R=(e,s)=>b(e,j(s)),D=(e,s,n)=>new Promise((t,a)=>{var i=e=>{try{l(n.next(e))}catch(s){a(s)}},r=e=>{try{l(n.throw(e))}catch(s){a(s)}},l=e=>e.done?t(e.value):Promise.resolve(e.value).then(i,r);l((n=n.apply(e,s)).next())}),k=({documents:t=[],filters:a={},selectedState:i,selectedMunicipality:r,onFiltersChange:l})=>{const[o,c]=n.useState(""),[u,h]=n.useState(!0),[y,p]=n.useState(!1),{connectionStatus:g,forceSync:S,getRShinyUrl:b,getSessionId:j,isConnected:v,isLoading:x,hasError:w,hasPendingSync:N}=((e={})=>{const{autoSync:s=!0,syncFiltersDelay:t=1e3,syncDocumentsDelay:a=2e3}=e,[i,r]=n.useState({isConnected:f.isConnected(),isLoading:!1,error:null,queueSize:f.getQueueSize(),lastSyncTime:null}),[l,o]=n.useState({filters:null,documents:null});n.useEffect(()=>f.onConnectionChange((e,s)=>{r(n=>R(T({},n),{isConnected:e,error:s?s.message:null,queueSize:f.getQueueSize()}))}),[]),n.useEffect(()=>()=>{l.filters&&clearTimeout(l.filters),l.documents&&clearTimeout(l.documents)},[l]);const c=n.useCallback(()=>{r(e=>R(T({},e),{queueSize:f.getQueueSize()}))},[]),u=n.useCallback((e,n=!1)=>D(null,null,function*(){if(!s&&!n)return;l.filters&&clearTimeout(l.filters);const a=()=>D(null,null,function*(){r(e=>R(T({},e),{isLoading:!0,error:null}));try{const s=yield f.syncFilters(e);return r(e=>R(T({},e),{isLoading:!1,lastSyncTime:Date.now(),queueSize:f.getQueueSize()})),c(),s}catch(s){return r(e=>R(T({},e),{isLoading:!1,error:s instanceof Error?s.message:"Sync failed",queueSize:f.getQueueSize()})),!1}});if(n)return yield a();{const e=setTimeout(a,t);o(s=>R(T({},s),{filters:e}))}}),[s,t,l.filters,c]),d=n.useCallback((e,n=!1)=>D(null,null,function*(){if(!s&&!n)return;l.documents&&clearTimeout(l.documents);const t=()=>D(null,null,function*(){r(e=>R(T({},e),{isLoading:!0,error:null}));try{const s=yield f.syncDocuments(e);return r(e=>R(T({},e),{isLoading:!1,lastSyncTime:Date.now(),queueSize:f.getQueueSize()})),c(),s}catch(s){return r(e=>R(T({},e),{isLoading:!1,error:s instanceof Error?s.message:"Sync failed",queueSize:f.getQueueSize()})),!1}});if(n)return yield t();{const e=setTimeout(t,a);o(s=>R(T({},s),{documents:e}))}}),[s,a,l.documents,c]),h=n.useCallback((e,s)=>D(null,null,function*(){r(e=>R(T({},e),{isLoading:!0,error:null}));try{const n=yield f.syncSelection(e,s);return r(e=>R(T({},e),{isLoading:!1,lastSyncTime:Date.now(),queueSize:f.getQueueSize()})),c(),n}catch(n){return r(e=>R(T({},e),{isLoading:!1,error:n instanceof Error?n.message:"Selection sync failed",queueSize:f.getQueueSize()})),!1}}),[c]),m=n.useCallback((e,...s)=>D(null,[e,...s],function*(e,s={}){r(e=>R(T({},e),{isLoading:!0,error:null}));try{const n=yield f.sendCommand(e,s);return r(e=>R(T({},e),{isLoading:!1,lastSyncTime:Date.now()})),n}catch(n){throw r(e=>R(T({},e),{isLoading:!1,error:n instanceof Error?n.message:"Command failed"})),n}}),[]),y=n.useCallback(()=>D(null,null,function*(){r(e=>R(T({},e),{isLoading:!0,error:null}));try{const e=yield f.getSessionData();return r(e=>R(T({},e),{isLoading:!1})),e}catch(e){throw r(s=>R(T({},s),{isLoading:!1,error:e instanceof Error?e.message:"Failed to get session data"})),e}}),[]),p=n.useCallback(()=>{f.clearQueue(),c()},[c]),g=n.useCallback(()=>f.getRShinyUrl(),[]),S=n.useCallback(()=>f.getSessionId(),[]),b=n.useCallback((e,s,n,t)=>D(null,null,function*(){return!(yield Promise.allSettled([e?u(e,!0):Promise.resolve(!0),s?d(s,!0):Promise.resolve(!0),void 0!==n||void 0!==t?h(n,t):Promise.resolve(!0)])).some(e=>"rejected"===e.status)}),[u,d,h]);return{connectionStatus:i,syncFilters:u,syncDocuments:d,syncSelection:h,sendCommand:m,getSessionData:y,forceSync:b,clearQueue:p,getRShinyUrl:g,getSessionId:S,isConnected:i.isConnected,isLoading:i.isLoading,hasError:!!i.error,hasPendingSync:i.queueSize>0,lastSyncTime:i.lastSyncTime}})({autoSync:!1,syncFiltersDelay:5e3,syncDocumentsDelay:1e4});n.useEffect(()=>{var e;e=function*(){h(!0);try{const e=((e,s={})=>{const n=new URL(d.baseUrl);return n.searchParams.set("session",e),n.searchParams.set("source","react"),n.searchParams.set("timestamp",Date.now().toString()),Object.entries(s).forEach(([e,s])=>{n.searchParams.set(e,s)}),n.toString()})(j(),{documentsCount:t.length.toString(),selectedState:i||"",selectedMunicipality:r||""});c(e),h(!1)}catch(e){console.error("Failed to initialize R Shiny connection:",e),p(!0),h(!1)}},new Promise((s,n)=>{var t=s=>{try{i(e.next(s))}catch(t){n(t)}},a=s=>{try{i(e.throw(s))}catch(t){n(t)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(t,a);i((e=e.apply(null,null)).next())})},[b,j,S,a,t,i,r]);const k=n.useMemo(()=>{const e=new Set(t.map(e=>e.state).filter(Boolean)).size,s=new Set(t.map(e=>e.type).filter(Boolean)).size,n=t.length>0?{earliest:new Date(Math.min(...t.map(e=>new Date(e.date).getTime()))),latest:new Date(Math.max(...t.map(e=>new Date(e.date).getTime())))}:null;return{totalDocuments:t.length,statesCount:e,documentTypesCount:s,dateRange:n}},[t]);return u?e.jsxs("div",{className:"analytics-page analytics-loading",children:[e.jsx(s,{message:"Initializing R Shiny Analytics..."}),e.jsxs("div",{className:"loading-details",children:[e.jsx("p",{children:"Setting up analytics workspace..."}),e.jsxs("p",{children:["Synchronizing ",t.length," documents"]})]})]}):y?e.jsx("div",{className:"analytics-page analytics-fallback",children:e.jsxs("div",{className:"fallback-content",children:[e.jsxs("div",{className:"fallback-header",children:[e.jsx("h2",{children:"📊 Analytics Dashboard"}),e.jsx("div",{className:"fallback-status",children:e.jsx("span",{className:"status-offline",children:"R Shiny Unavailable"})})]}),e.jsxs("div",{className:"fallback-summary",children:[e.jsx("h3",{children:"Data Summary"}),e.jsxs("div",{className:"summary-grid",children:[e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-value",children:k.totalDocuments}),e.jsx("span",{className:"summary-label",children:"Documents"})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-value",children:k.statesCount}),e.jsx("span",{className:"summary-label",children:"States"})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-value",children:k.documentTypesCount}),e.jsx("span",{className:"summary-label",children:"Document Types"})]}),k.dateRange&&e.jsxs("div",{className:"summary-item",children:[e.jsxs("span",{className:"summary-value",children:[k.dateRange.earliest.getFullYear()," - ",k.dateRange.latest.getFullYear()]}),e.jsx("span",{className:"summary-label",children:"Date Range"})]})]})]}),e.jsxs("div",{className:"fallback-message",children:[e.jsx("p",{children:"The R Shiny analytics application is running locally but cannot be accessed from GitHub Pages due to browser security restrictions (HTTPS → HTTP blocking)."}),e.jsx("h4",{children:"📋 How to Access R Shiny Analytics:"}),e.jsxs("div",{className:"access-instructions",children:[e.jsxs("div",{className:"instruction-item",children:[e.jsx("strong",{children:"Option 1: Direct Access"}),e.jsx("p",{children:"Open R Shiny directly in a new tab:"}),e.jsx("a",{href:"http://localhost:3838",target:"_blank",rel:"noopener noreferrer",className:"external-btn",children:"🔗 Open R Shiny Dashboard"}),e.jsxs("p",{className:"login-info",children:["Login: ",e.jsx("code",{children:"admin"})," / ",e.jsx("code",{children:"admin123"})]})]}),e.jsxs("div",{className:"instruction-item",children:[e.jsx("strong",{children:"Option 2: Local Development"}),e.jsx("p",{children:"Run the React app locally to enable full integration:"}),e.jsx("code",{children:"npm run dev"}),e.jsxs("p",{children:["Then visit: ",e.jsx("a",{href:"http://localhost:3000/monitor-legislativo-v4/",target:"_blank",children:"http://localhost:3000/monitor-legislativo-v4/"})]})]})]}),e.jsx("div",{className:"fallback-actions",children:e.jsx("button",{onClick:()=>{p(!1),h(!0),window.location.reload()},className:"retry-btn",children:"🔄 Test Connection Again"})})]})]})}):e.jsxs("div",{className:"analytics-page",children:[e.jsxs("div",{className:"analytics-header",children:[e.jsx("h2",{children:"📊 Advanced Analytics"}),e.jsxs("div",{className:"analytics-status",children:[e.jsxs("div",{className:"connection-indicator "+(v?"connected":"disconnected"),children:[e.jsx("span",{className:"status-dot"}),v?"Connected":"Disconnected"]}),x&&e.jsxs("div",{className:"sync-indicator",children:[e.jsx("span",{className:"sync-spinner",children:"⟳"}),"Syncing..."]}),N&&e.jsxs("div",{className:"queue-indicator",children:[e.jsx("span",{className:"queue-count",children:g.queueSize}),"Queued"]}),w&&e.jsx("div",{className:"error-indicator",title:g.error||"Unknown error",children:"⚠️ Sync Error"})]})]}),e.jsxs("div",{className:"analytics-summary",children:[e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-value",children:k.totalDocuments}),e.jsx("span",{className:"summary-label",children:"Documents Loaded"})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-value",children:k.statesCount}),e.jsx("span",{className:"summary-label",children:"States"})]}),i&&e.jsxs("div",{className:"summary-item selected",children:[e.jsx("span",{className:"summary-value",children:i}),e.jsx("span",{className:"summary-label",children:"Selected State"})]}),r&&e.jsxs("div",{className:"summary-item selected",children:[e.jsx("span",{className:"summary-value",children:r}),e.jsx("span",{className:"summary-label",children:"Selected Municipality"})]})]}),e.jsx("div",{className:"analytics-content",children:e.jsx(m,{url:o,title:"Legislative Analytics Dashboard",height:"calc(100vh - 200px)",onLoad:()=>{console.log("R Shiny application loaded successfully")},onError:e=>{console.error("R Shiny application error:",e),p(!0)},className:"main-analytics-embed",allowFullscreen:!0})}),e.jsxs("div",{className:"analytics-footer",children:[e.jsx("div",{className:"sync-info",children:g.lastSyncTime&&e.jsxs("span",{className:"last-sync",children:["Last sync: ",new Date(g.lastSyncTime).toLocaleTimeString()]})}),e.jsx("div",{className:"analytics-controls",children:e.jsx("button",{onClick:()=>S(a,t,i,r),disabled:x,className:"force-sync-btn",children:x?"⟳ Syncing...":"🔄 Force Sync"})})]})]})};export{k as default};
